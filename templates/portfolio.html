<!DOCTYPE html>
<html lang="en" class="h-full" x-data="{ darkMode: localStorage.getItem('theme') === 'dark' }" :class="{ 'dark': darkMode }">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SageAlpha.ai â€” Portfolio</title>
  
  <!-- Tailwind CSS 3.x CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            sage: {
              50: '#faf5ff',
              100: '#f3e8ff',
              200: '#e9d5ff',
              300: '#d8b4fe',
              400: '#c084fc',
              500: '#a855f7',
              600: '#9333ea',
              700: '#7c3aed',
              800: '#6b21a8',
              900: '#581c87',
              950: '#3b0764',
            },
            primary: '#8B5CF6',
          },
          fontFamily: {
            display: ['Clash Display', 'system-ui', 'sans-serif'],
            sans: ['Satoshi', 'Inter', 'system-ui', 'sans-serif'],
          },
        }
      }
    }
  </script>
  
  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    @import url('https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700&f[]=clash-display@600,700&display=swap');
    body { font-family: 'Satoshi', 'Inter', system-ui, sans-serif; }
    
    .glass-sidebar {
      background: linear-gradient(180deg, rgba(30, 27, 75, 0.95) 0%, rgba(49, 46, 129, 0.9) 100%);
      backdrop-filter: blur(20px);
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
    }
    
    .dark .glass-card {
      background: rgba(30, 41, 59, 0.9);
    }
    
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.3); border-radius: 3px; }
  </style>
</head>

<body class="h-full bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 transition-colors duration-300">
  
  <div x-data="portfolioApp()" x-init="init()" class="h-full flex flex-col">
    
    <!-- Top Navigation -->
    <header class="bg-white/80 dark:bg-slate-900/90 backdrop-blur-xl sticky top-0 z-50 border-b border-slate-200/50 dark:border-slate-800/50">
      <div class="flex items-center justify-between px-6 h-16">
        <div class="flex items-center gap-3">
          <a href="/" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
            <img src="{{ url_for('static', filename='img/sagealpha-logo.png') }}"
                 alt="SageAlpha" class="h-8 w-auto" onerror="this.style.display='none'">
            <span class="font-display font-bold text-lg">SageAlpha</span>
          </a>
          <span class="text-xs bg-sage-100 dark:bg-sage-900/50 text-sage-700 dark:text-sage-300 px-2 py-0.5 rounded-full font-medium">
            v{{ APP_VERSION }}
          </span>
        </div>
        
        <div class="flex items-center gap-3">
          <button @click="toggleTheme()"
                  class="p-2.5 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
            <svg x-show="!darkMode" class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
            </svg>
            <svg x-show="darkMode" class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
          </button>
          <a href="/" class="p-2.5 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>
          </a>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto p-6">
      <div class="max-w-7xl mx-auto">
        
        <!-- Page Title -->
        <div class="mb-8">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h1 class="text-3xl font-display font-bold text-slate-900 dark:text-white mb-2">Portfolio</h1>
              <p class="text-slate-600 dark:text-slate-400">Manage your researched companies and approve reports for distribution.</p>
            </div>
            <!-- Date Picker -->
            <div class="flex items-center gap-3">
              <label class="text-sm font-medium text-slate-700 dark:text-slate-300">Date:</label>
              <input type="date" 
                     x-model="selectedDate"
                     @change="changeDate()"
                     class="px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-sage-500 focus:border-transparent">
            </div>
          </div>
        </div>
        
        <!-- Two Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
          
          <!-- Left Column: Portfolio Items (30%) -->
          <div class="lg:col-span-4">
            <div class="glass-card rounded-2xl shadow-lg border border-slate-200/50 dark:border-slate-700/50 p-6">
              <h2 class="text-lg font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-sage-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                </svg>
                Portfolio
              </h2>
              
              {% if portfolio_items %}
              <div class="space-y-3">
                {% for item in portfolio_items %}
                <div class="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-4 border border-slate-200 dark:border-slate-700 hover:border-sage-400 dark:hover:border-sage-500 transition-colors cursor-pointer"
                     @click="selectCompany({{ item.id }})">
                  <div class="flex items-start justify-between">
                    <div>
                      <h3 class="font-semibold text-slate-900 dark:text-white">{{ item.company_name }}</h3>
                      {% if item.ticker %}
                      <span class="text-xs text-sage-600 dark:text-sage-400 font-mono bg-sage-100 dark:bg-sage-900/50 px-2 py-0.5 rounded">{{ item.ticker }}</span>
                      {% endif %}
                    </div>
                    <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                  </div>
                  <p class="text-xs text-slate-500 dark:text-slate-400 mt-2">From recent research</p>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <p class="text-sm">No portfolio items for this date.</p>
                <p class="text-xs mt-1">Start researching companies in the chat to add them.</p>
              </div>
              {% endif %}
            </div>
          </div>
          
          <!-- Right Column: Reports (70%) -->
          <div class="lg:col-span-8">
            <div class="glass-card rounded-2xl shadow-lg border border-slate-200/50 dark:border-slate-700/50 p-6">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-slate-900 dark:text-white flex items-center gap-2">
                  <svg class="w-5 h-5 text-sage-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  Pre-Approved Reports
                </h2>
                {% if reports %}
                <div class="flex items-center gap-2">
                  <label class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400 cursor-pointer">
                    <input type="checkbox" 
                           @change="toggleSelectAll($event.target.checked)"
                           :checked="selectedReports.length === reports.length && reports.length > 0"
                           class="w-4 h-4 text-sage-600 rounded border-slate-300 dark:border-slate-600 focus:ring-sage-500">
                    Select All
                  </label>
                </div>
                {% endif %}
              </div>
              
              {% if reports %}
              <div class="space-y-4">
                {% for report in reports %}
                <div class="report-card bg-slate-50 dark:bg-slate-800/50 rounded-xl p-5 border border-slate-200 dark:border-slate-700 hover:border-sage-400 dark:hover:border-sage-500 transition-colors"
                     :class="selectedReports.includes({{ report.id }}) ? 'border-sage-500 dark:border-sage-400' : ''">
                  <div class="flex items-start gap-4">
                    <!-- Checkbox -->
                    <input type="checkbox" 
                           name="selected_reports"
                           :value="{{ report.id }}"
                           @change="toggleReport({{ report.id }}, $event.target.checked)"
                           :checked="selectedReports.includes({{ report.id }})"
                           class="report-checkbox mt-1 w-4 h-4 text-sage-600 rounded border-slate-300 dark:border-slate-600 focus:ring-sage-500 flex-shrink-0">
                    
                    <!-- Report Content -->
                    <div class="report-content flex-1 flex items-start justify-between gap-4">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                          <h3 class="font-semibold text-slate-900 dark:text-white">{{ report.company_name or 'Company' }}</h3>
                          {% if report.ticker %}
                          <span class="text-xs font-mono text-slate-500">({{ report.ticker }})</span>
                          {% endif %}
                        </div>
                        <p class="text-sm text-slate-600 dark:text-slate-400">{{ report.title }}</p>
                        <p class="text-xs text-slate-500 mt-1">Created: {{ report.created_at[:10] if report.created_at else 'N/A' }}</p>
                      </div>
                      
                      <div class="flex items-center gap-3 flex-shrink-0">
                        <!-- Status Badge -->
                        {% if report.status == 'approved' %}
                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300">
                          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                          </svg>
                          Approved
                        </span>
                        {% else %}
                        <span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300">
                          <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                          </svg>
                          Pending Approval
                        </span>
                        {% endif %}
                        
                        <!-- Preview Button - Opens full PDF-style report in new tab -->
                        <a href="{{ url_for('portfolio.report_preview_full', report_id=report.id) }}"
                           target="_blank"
                           class="px-4 py-2 text-sm font-medium text-sage-700 dark:text-sage-300 bg-sage-100 dark:bg-sage-900/50 rounded-lg hover:bg-sage-200 dark:hover:bg-sage-800 transition-colors inline-flex items-center gap-2">
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                          </svg>
                          Preview
                        </a>
                        
                        <!-- Approve Button -->
                        {% if report.status != 'approved' %}
                        <button @click="approveReport({{ report.id }})"
                                class="px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-sage-500 to-sage-600 rounded-lg hover:from-sage-600 hover:to-sage-700 shadow-lg shadow-sage-500/25 transition-all">
                          Approve
                        </button>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              
              <!-- Action Buttons -->
              <div class="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                <div class="flex items-center gap-3 mb-4">
                  <button @click="deleteSelected()"
                          :disabled="selectedReports.length === 0"
                          class="px-4 py-2 text-sm font-medium text-red-700 dark:text-red-400 bg-red-100 dark:bg-red-900/50 rounded-lg hover:bg-red-200 dark:hover:bg-red-900/70 transition-colors disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                    Delete Selected (<span x-text="selectedReports.length"></span>)
                  </button>
                  <button @click="editSelected()"
                          :disabled="selectedReports.length !== 1"
                          class="px-4 py-2 text-sm font-medium text-sage-700 dark:text-sage-300 bg-sage-100 dark:bg-sage-900/50 rounded-lg hover:bg-sage-200 dark:hover:bg-sage-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Edit Selected
                  </button>
                </div>
                
                <!-- Proceed Button -->
                {% if all_approved %}
                <button @click="proceedToSubscribers()"
                        :disabled="selectedReports.length === 0"
                        class="w-full inline-flex items-center justify-center gap-2 px-6 py-4 text-lg font-semibold text-white bg-gradient-to-r from-sage-500 to-sage-600 rounded-xl hover:from-sage-600 hover:to-sage-700 shadow-lg shadow-sage-500/25 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                  <span>Proceed to Subscribers</span>
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                  </svg>
                </button>
                {% else %}
                <button disabled
                        class="w-full inline-flex items-center justify-center gap-2 px-6 py-4 text-lg font-semibold text-slate-400 bg-slate-200 dark:bg-slate-700 rounded-xl cursor-not-allowed">
                  <span>Approve All Reports to Proceed</span>
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                  </svg>
                </button>
                {% endif %}
              </div>
              
              {% else %}
              <div class="text-center py-12 text-slate-500 dark:text-slate-400">
                <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <p class="text-lg font-medium">No portfolio items for this date.</p>
                <p class="text-sm mt-1">Start researching companies in the chat to add them to your portfolio.</p>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <!-- Report Preview Modal -->
    <div x-show="showPreviewModal"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
         style="display: none;"
         @click.self="showPreviewModal = false">
      
      <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[80vh] overflow-hidden"
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 scale-95"
           x-transition:enter-end="opacity-100 scale-100">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-700">
          <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Report Preview</h3>
          <button @click="showPreviewModal = false"
                  class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <!-- Modal Content -->
        <div class="p-6 overflow-y-auto max-h-[60vh] prose dark:prose-invert prose-slate max-w-none"
             x-html="previewContent">
          <p class="text-slate-500 dark:text-slate-400">Loading preview...</p>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex justify-end gap-3 px-6 py-4 border-t border-slate-200 dark:border-slate-700">
          <button @click="showPreviewModal = false"
                  class="px-4 py-2 text-sm font-medium text-slate-700 dark:text-slate-300 bg-slate-100 dark:bg-slate-800 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
            Close
          </button>
        </div>
      </div>
    </div>
    
    <!-- Edit Report Modal -->
    <div x-show="editModalOpen"
         x-transition:enter="transition ease-out duration-200"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-150"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm"
         style="display: none;"
         @click.self="editModalOpen = false">
      
      <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl max-w-md w-full"
           x-transition:enter="transition ease-out duration-200"
           x-transition:enter-start="opacity-0 scale-95"
           x-transition:enter-end="opacity-100 scale-100">
        
        <!-- Modal Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-700">
          <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Edit Report</h3>
          <button @click="editModalOpen = false; editingReport = null"
                  class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <!-- Modal Content -->
        <div class="p-6 space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Company Name</label>
            <input type="text" 
                   x-model="editCompanyName"
                   class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-sage-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Report Title</label>
            <input type="text" 
                   x-model="editTitle"
                   class="w-full px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-sage-500 focus:border-transparent">
          </div>
        </div>
        
        <!-- Modal Footer -->
        <div class="flex justify-end gap-3 px-6 py-4 border-t border-slate-200 dark:border-slate-700">
          <button @click="editModalOpen = false; editingReport = null"
                  class="px-4 py-2 text-sm font-medium text-slate-700 dark:text-slate-300 bg-slate-100 dark:bg-slate-800 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
            Cancel
          </button>
          <button @click="saveEdit()"
                  class="px-4 py-2 text-sm font-medium text-white bg-gradient-to-r from-sage-500 to-sage-600 rounded-lg hover:from-sage-600 hover:to-sage-700 transition-colors">
            Save Changes
          </button>
        </div>
      </div>
    </div>
    
    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
  </div>

  <script>
    function portfolioApp() {
      return {
        darkMode: localStorage.getItem('theme') === 'dark',
        showPreviewModal: false,
        previewContent: '',
        allApproved: {{ 'true' if all_approved else 'false' }},
        selectedDate: '{{ selected_date }}',
        selectedReports: [],
        editModalOpen: false,
        editingReport: null,
        editTitle: '',
        editCompanyName: '',
        
        init() {
          this.applyTheme();
        },
        
        toggleTheme() {
          this.darkMode = !this.darkMode;
          localStorage.setItem('theme', this.darkMode ? 'dark' : 'light');
          this.applyTheme();
        },
        
        applyTheme() {
          if (this.darkMode) {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
        },
        
        selectCompany(itemId) {
          // Could scroll to related report or highlight
          console.log('Selected company:', itemId);
        },
        
        async previewReport(reportId) {
          this.previewContent = '<p class="text-slate-500">Loading preview...</p>';
          this.showPreviewModal = true;
          
          try {
            const res = await fetch(`/portfolio/report-preview/${reportId}`);
            const data = await res.json();
            
            if (data.success) {
              this.previewContent = data.preview_html;
            } else {
              this.previewContent = `<p class="text-red-500">Error: ${data.error}</p>`;
            }
          } catch (e) {
            this.previewContent = '<p class="text-red-500">Failed to load preview.</p>';
          }
        },
        
        async approveReport(reportId) {
          try {
            const res = await fetch(`/portfolio/approve/${reportId}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' }
            });
            const data = await res.json();
            
            if (data.success) {
              this.showToast('Report approved successfully!', 'success');
              // Reload page to reflect changes
              setTimeout(() => location.reload(), 500);
            } else {
              this.showToast(data.error || 'Failed to approve report', 'error');
            }
          } catch (e) {
            this.showToast('Network error. Please try again.', 'error');
          }
        },
        
        changeDate() {
          // Reload page with new date
          window.location.href = `/portfolio?date=${this.selectedDate}`;
        },
        
        toggleReport(reportId, checked) {
          if (checked) {
            if (!this.selectedReports.includes(reportId)) {
              this.selectedReports.push(reportId);
            }
          } else {
            this.selectedReports = this.selectedReports.filter(id => id !== reportId);
          }
        },
        
        toggleSelectAll(checked) {
          const reportIds = [{% for report in reports %}{{ report.id }}{% if not loop.last %}, {% endif %}{% endfor %}];
          if (checked) {
            this.selectedReports = [...reportIds];
          } else {
            this.selectedReports = [];
          }
        },
        
        async deleteSelected() {
          if (this.selectedReports.length === 0) return;
          
          if (!confirm(`Are you sure you want to delete ${this.selectedReports.length} report(s)?`)) {
            return;
          }
          
          try {
            const res = await fetch('/portfolio/reports/delete', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ report_ids: this.selectedReports })
            });
            const data = await res.json();
            
            if (data.success) {
              this.showToast(`Deleted ${data.deleted_count} report(s) successfully!`, 'success');
              this.selectedReports = [];
              setTimeout(() => location.reload(), 500);
            } else {
              this.showToast(data.error || 'Failed to delete reports', 'error');
            }
          } catch (e) {
            this.showToast('Network error. Please try again.', 'error');
          }
        },
        
        async editSelected() {
          if (this.selectedReports.length !== 1) return;
          
          const reportId = this.selectedReports[0];
          
          try {
            const res = await fetch(`/portfolio/reports/${reportId}/edit`);
            const data = await res.json();
            
            if (data.report) {
              this.editingReport = reportId;
              this.editTitle = data.report.title || '';
              this.editCompanyName = data.report.company_name || '';
              this.editModalOpen = true;
            } else {
              this.showToast(data.error || 'Failed to load report', 'error');
            }
          } catch (e) {
            this.showToast('Network error. Please try again.', 'error');
          }
        },
        
        async saveEdit() {
          if (!this.editingReport) return;
          
          try {
            const res = await fetch(`/portfolio/reports/${this.editingReport}/edit`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                title: this.editTitle,
                company_name: this.editCompanyName
              })
            });
            const data = await res.json();
            
            if (data.success) {
              this.showToast('Report updated successfully!', 'success');
              this.editModalOpen = false;
              this.editingReport = null;
              setTimeout(() => location.reload(), 500);
            } else {
              this.showToast(data.error || 'Failed to update report', 'error');
            }
          } catch (e) {
            this.showToast('Network error. Please try again.', 'error');
          }
        },
        
        proceedToSubscribers() {
          if (this.selectedReports.length === 0) {
            this.showToast('Please select at least one report', 'error');
            return;
          }
          
          // Build URL with selected report IDs
          const params = new URLSearchParams();
          this.selectedReports.forEach(id => params.append('report_ids', id));
          window.location.href = `/subscribers?${params.toString()}`;
        },
        
        showToast(message, type = 'info') {
          const container = document.getElementById('toast-container');
          const toast = document.createElement('div');
          const bgColors = {
            info: 'bg-slate-800 text-white',
            success: 'bg-green-600 text-white',
            error: 'bg-red-600 text-white'
          };
          toast.className = `px-4 py-3 rounded-xl shadow-lg ${bgColors[type]} animate-slide-up`;
          toast.textContent = message;
          container.appendChild(toast);
          
          setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s ease';
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        }
      };
    }
  </script>
  
  <style>
    /* Report preview styles */
    .report-preview-content {
      font-size: 14px;
      line-height: 1.6;
    }
    .report-preview-content .report-header {
      border-bottom: 2px solid #8B5CF6;
      padding-bottom: 16px;
      margin-bottom: 20px;
    }
    .report-preview-content .report-header h2 {
      margin: 0 0 4px 0;
      font-size: 24px;
      color: #1f2937;
    }
    .dark .report-preview-content .report-header h2 {
      color: #f3f4f6;
    }
    .report-preview-content .ticker {
      color: #6b7280;
      font-weight: normal;
    }
    .report-preview-content .report-type {
      color: #8B5CF6;
      font-weight: 600;
      margin: 0;
    }
    .report-preview-content .report-date {
      color: #9ca3af;
      font-size: 12px;
      margin: 4px 0 0;
    }
    .report-preview-content .report-section {
      margin-bottom: 20px;
    }
    .report-preview-content .report-section h3 {
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #8B5CF6;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 6px;
      margin-bottom: 12px;
    }
    .dark .report-preview-content .report-section h3 {
      border-color: #374151;
    }
    .report-preview-content ul {
      padding-left: 20px;
      margin: 0;
    }
    .report-preview-content li {
      margin-bottom: 6px;
    }
    .report-preview-content .report-footer {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
      text-align: center;
    }
    .dark .report-preview-content .report-footer {
      border-color: #374151;
    }
    
    @keyframes slide-up {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .animate-slide-up {
      animation: slide-up 0.3s ease-out;
    }
  </style>
</body>
</html>

